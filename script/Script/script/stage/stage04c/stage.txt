#TouhouDanmakufu[Stage]
#ScriptVersion[1]
#Title["Stage 04c"]
#Text["Stage4C"]
#Background["./stage0Tbg.txt"]
#System["./../../lib/system/System.txt"]
#include "./../../lib/lib_stageall.txt"
#include "./../Initiate.txt"

@Initialize
{
	RecordStageHistory("04c", DIFFICULTY_NAMES[DIFFICULTY]);
	SetAutoDeleteObject(true);
	LoadBoss();
	InitialiseIndiv();
	SetForbidPlayerSpell(true);
	EndStage;
	StartStage;
}

@MainLoop
{
	let smooth1 = GetCommonData("Smoother",0);
	let smooth2 = 1-smooth1;

	x1 = (107);
	x2 = (GetScreenWidth-107);
	SetStgFrame(x1,0,x2,480,10,80);
	SetPlayerClip(8,16,GetStgFrameWidth-8,GetStgFrameHeight-16);
	if(GetPlayerY<150){CollectAllItems;}
	HandleMusicVolume();
	yield;
}

@Event
{
	HandleMusicEvent(GetEventType);
}

@Finalize
{
	DeleteMusicObj();
}

task Dialog
{
}

let Boss;
let Boss2;
task LoadBoss()
{
	Boss=ObjEnemyBossScene_Create();
	Boss2=ObjEnemyBossScene_Create();
	ObjEnemyBossScene_Add(Boss,0,GetCurrentScriptDirectory~"Ns1.txt");
	
	ObjEnemyBossScene_Add(Boss2,0,GetCurrentScriptDirectory~"S1.txt");
	ObjEnemyBossScene_Add(Boss2,1,GetCurrentScriptDirectory~"S2.txt");
	ObjEnemyBossScene_Add(Boss2,2,GetCurrentScriptDirectory~"S3.txt");
	ObjEnemyBossScene_Add(Boss2,3,GetCurrentScriptDirectory~"S4.txt");
	
	ObjEnemyBossScene_LoadInThread(Boss);
	ObjEnemyBossScene_LoadInThread(Boss2);
}

task StartStage
{	

	BGTransition(255, 255, 60);
	wait(60);
	BGTransition(255, 0, 120);
	wait(120);
	SetCommonData("MaxNumberOfPhases",0);
	MusicChange(BGM_BOSS_04C, 85, 22423, 7994797);
	SetCommonData("LifeBombAlpha",255);
	SetForbidPlayerSpell(false);
	loop(1)
	{
		ObjEnemyBossScene_Regist(Boss);	
		while(!Obj_IsDeleted(Boss)) { yield; }
		wait(60);
		SetCommonData("MaxNumberOfPhases",3);
		ObjEnemyBossScene_Regist(Boss2);	
		while(!Obj_IsDeleted(Boss2)) { yield; }
		EndStageHistoryRecord();
		wait(300);
		MusicVolumeChange(GetBGMVolume, 0, 90);
		BGTransition(0, 255, 91);
		wait(90);
		DeleteMusicObj();
		CloseStgScene;
	}
}

